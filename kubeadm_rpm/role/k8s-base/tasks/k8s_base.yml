---
# tasks file for container-runtimes

- name: swap off
  shell: swapoff -a
  tags:
    - k8s_base

- name: net.ipv4.ip_forward=1
  shell: sysctl -w net.ipv4.ip_forward=1
  tags:
    - k8s_base

- name: rewrite fstab
  shell: sed -i '/swap/s/^/#/' /etc/fstab
  tags:
    - k8s_base

- name: modprobe br_netfilter
  shell: 'modprobe br_netfilter'
  tags:
    - k8s_base

- name: sysctl net bridge
  shell: sysctl -w net.bridge.bridge-nf-call-iptables=1
  tags:
    - k8s_base

- name: disble Firewalld
  shell: ufw disable
  tags:
    - k8s_base

- name: disable systemd-resolved
  systemd:
    name: systemd-resolved
    state: stopped
    enabled: no
  tags:
    - k8s_base

- name: Cofigure DNS default
  shell: sed -i '/\[main\]/a dns=default' /etc/NetworkManager/NetworkManager.conf
  tags:
    - k8s_base

- name: unlink resolv.conf
  shell: unlink /etc/resolv.conf || true
  tags:
    - k8s_base

- name: touch resolv.conf
  file:
    path: /etc/resolv.conf
    state: touch
  tags:
    - k8s_base

- name: set-hostname
  hostname:
    name: "{{ inventory_hostname }}"
  tags:
    - k8s_base

- name: copy /etc/hosts
  copy:
    src: /etc/hosts
    dest: /etc/hosts
  tags:
    - k8s_base

- name: copy /etc/resolv.conf
  copy:
    src: /etc/resolv.conf
    dest: /etc/resolv.conf
  tags:
    - k8s_base

- name: crio.conf
  shell: sed -i -e 's|# insecure_registries = \[|insecure_registries = [\n  "192.168.56.1:5443"\n]|g' /etc/crio/crio.conf
  tags:
    - k8s_base

- name: crio process restart
  systemd:
    name: crio
    state: restarted
  tags:
    - k8s_base

- name: pull images
  shell: "crictl pull 192.168.56.1:5443/{{ item }}"
  with_items:
    - registry:2.8.2
    - registry.k8s.io/kube-apiserver:v1.28.2
    - registry.k8s.io/kube-scheduler:v1.28.2
    - registry.k8s.io/kube-controller-manager:v1.28.2
    - registry.k8s.io/kube-proxy:v1.28.2
    - calico/kube-controllers:v3.26.1
    - calico/cni:v3.26.1
    - calico/node:v3.26.1
    - flannel/flannel:v0.22.0
    - registry.k8s.io/coredns:v1.10.1
    - registry.k8s.io/etcd:3.5.9-0
    - flannel/flannel-cni-plugin:v1.1.2
    - registry.k8s.io/pause:3.9
  tags:
    - k8s_base
    - images
